@startuml Simulacion_Flujo_Mejorado

title Diagrama de Flujo - Simulación Evento a Evento
skinparam backgroundColor #FAFAFA
skinparam activity {
  BackgroundColor #E8F4FD
  BorderColor #1E88E5
  FontColor #1565C0
}
skinparam decision {
  BackgroundColor #FFF3E0
  BorderColor #FB8C00
  FontColor #EF6C00
}

start

:INICIALIZACIÓN
Variables y condiciones iniciales;

note right
  **Condiciones Iniciales:**
  * tiempo_simulacion = 0
  * tiempo_proxima_llegada = 0
  * personas_en_sistema = 0
  * cantidad_servidores = n
  * suma_tiempo_permanencia = 0
  * suma_tiempo_atencion = 0
  * personas_atendidas = 0
  * vi = 1..n
end note

repeat

  :Buscar el menor tiempo_proxima_salida(i);
  
  note right: k = argmin(TPS[1..n])
  
  if (tiempo_proxima_llegada ≤ tiempo_proxima_salida(k)?) then (SÍ)
    
    group EVENTO: LLEGADA
      :suma_tiempo_permanencia += (tiempo_proxima_llegada - tiempo_simulacion) * personas_totales_sistema;
      :tiempo_simulacion = tiempo_proxima_llegada;
      :Generar tiempo_entre_arribos;
      :tiempo_proxima_llegada = tiempo_simulacion + tiempo_entre_arribos;
      
      :Buscar en Cola del Menor cantidad de Personas;
      :Tratar Arrepentimiento;
      
      note right
        **Rangos de Arrepentimiento:**
        * 15+ min: 20% se va (80% se queda)
        * 20+ min: 45% se va (55% se queda)
        * 25+ min: 96% se va (4% se queda)
      end note
      
      :personas_en_sistema(k) += 1;
      :personas_totales_sistema += 1;
      
      if (personas_en_sistema(k) = 1?) then (SÍ)
        :Generar tiempo_atencion;
        :tiempo_proxima_salida(k) = tiempo_simulacion + tiempo_atencion;
        :suma_tiempo_atencion(k) += tiempo_atencion;
      else (NO)
        note right: Cliente va a cola, no se asigna tiempo de servicio aún
      endif
    end group
    
  else (NO)
    
    group EVENTO: SALIDA
      :suma_tiempo_permanencia += (tiempo_proxima_salida(k) - tiempo_simulacion) * personas_totales_sistema;
      :tiempo_simulacion = tiempo_proxima_salida(k);
      :personas_en_sistema(k) -= 1;
      
      if (personas_en_sistema(k) ≥ 1?) then (SÍ)
        :Generar tiempo_atencion;
        :tiempo_proxima_salida(k) = tiempo_simulacion + tiempo_atencion;
        :suma_tiempo_atencion(k) += tiempo_atencion;
      else (NO)
        :tiempo_proxima_salida(k) = INFINITO;
      endif
    end group
    
  endif

repeat while (tiempo_simulacion < tiempo_fin?) is (NO)
-> SÍ;

:Calcular estadísticas finales;

note right
  **Para cada i calcular:**
  * promedio_tiempo_permanencia = suma_tiempo_permanencia / personas_atendidas
  * promedio_tiempo_atencion = suma_tiempo_atencion / personas_atendidas
  * porcentaje_ocupacion = suma_tiempo_atencion / tiempo_simulacion
end note

stop

@enduml 